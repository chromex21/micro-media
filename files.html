<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Files - Lite Media</title>
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/file-preview.css">
    <link rel="stylesheet" href="css/files-view.css">
    <link rel="stylesheet" href="css/mobile-header.css">
    <script src="js/storage-polyfill.js"></script>
    <script src="js/storage-events.js"></script>
    <style>
        /* Base container styles */
        .files-grid,
        .files-list {
            padding: var(--spacing-lg) 0;
        }
        
        /* Grid view (default) */
        #files-container.view-grid,
        .files-grid.view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-md);
            padding: var(--spacing-lg) 0;
        }
        
        /* List view */
        #files-container.view-list,
        .files-grid.view-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }
        
        #files-container.view-list .file-card {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
        }
        
        #files-container.view-list .file-icon {
            font-size: 32px;
            margin: 0;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-primary);
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }
        
        #files-container.view-list .file-name {
            font-size: 14px;
            margin: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex: 1;
            min-width: 0;
        }
        
        #files-container.view-list .file-description {
            display: none; /* Hide in list view */
        }
        
        #files-container.view-list .file-meta {
            flex-shrink: 0;
            display: flex;
            gap: var(--spacing-md);
            font-size: 12px;
        }
        
        #files-container.view-list .btn-group {
            flex-shrink: 0;
            margin: 0;
        }
        
        .file-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--spacing-md);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }
        
        .file-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .file-icon {
            font-size: 48px;
            margin-bottom: var(--spacing-sm);
            text-align: center;
        }
        
        .file-name {
            font-weight: 600;
            margin-bottom: var(--spacing-xs);
            font-size: 16px;
            color: var(--text-primary);
        }
        
        .file-description {
            font-size: 14px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
            line-height: 1.4;
        }
        
        .file-meta {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-secondary);
            padding-top: var(--spacing-sm);
            border-top: 1px solid var(--border-color);
        }
        
        .download-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            background: var(--accent-color);
            color: white;
            border-radius: var(--radius-sm);
            text-decoration: none;
            font-size: 12px;
            font-weight: 500;
            transition: opacity 0.2s;
            margin-top: var(--spacing-sm);
        }
        
        .download-btn:hover {
            opacity: 0.9;
        }
        
        .empty-state {
            text-align: center;
            padding: var(--spacing-xxl) var(--spacing-lg);
            color: var(--text-secondary);
        }
        
        .empty-state-icon {
            font-size: 64px;
            margin-bottom: var(--spacing-md);
            opacity: 0.5;
        }
        
        /* PDF Modal Viewer */
        .pdf-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-lg);
        }
        
        .pdf-modal.active {
            display: flex;
        }
        
        .pdf-modal-content {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            width: 100%;
            max-width: 900px;
            height: 90vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }
        
        .pdf-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
        }
        
        .pdf-modal-header h3 {
            font-size: 18px;
            margin: 0;
        }
        
        .pdf-close-btn {
            font-size: 32px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .pdf-close-btn:hover {
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .pdf-modal-body {
            flex: 1;
            overflow: hidden;
        }
        
        .pdf-viewer {
            width: 100%;
            height: 100%;
            border: none;
        }
    </style>
</head>
<body>
    <div class="app">
        <button class="sidebar-toggle" type="button" aria-label="Toggle navigation">‚ò∞</button>
        <nav class="sidebar">
            <div class="sidebar-header">
                <h1 class="site-logo">
                    <span class="logo-icon">‚ñ∂</span>
                    <span class="logo-text">Lite Media</span>
                </h1>
            </div>
            <ul class="nav-list">
                <li class="nav-item">
                    <a href="index.html" class="nav-link">Feed</a>
                </li>
                <li class="nav-item">
                    <a href="files.html" class="nav-link nav-link--active">Files</a>
                </li>
                <li class="nav-item">
                    <a href="links.html" class="nav-link">Links</a>
                </li>
                <li class="nav-item" style="margin-top: auto; padding-top: var(--spacing-xl); border-top: 1px solid var(--border-color);">
                    <a href="#settings" class="nav-link" id="settings-btn">‚öôÔ∏è Settings</a>
                </li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="files-page-header" style="display: flex; justify-content: space-between; align-items: center; padding: var(--spacing-lg); border-bottom: 1px solid var(--border-color); margin-bottom: 0;">
                <div>
                    <h1 style="font-size: 24px; margin: 0;">Files Directory</h1>
                    <p id="file-count" style="font-size: 14px; color: var(--text-secondary); margin: 4px 0 0 0;">Loading...</p>
                </div>
                <!-- View toggle will be injected here by files-view-toggle.js -->
            </div>
            
            <!-- Search and Filter Bar -->
            <div class="files-controls" style="padding: var(--spacing-md) var(--spacing-lg); border-bottom: 1px solid var(--border-color); display: flex; gap: var(--spacing-md); flex-wrap: wrap; align-items: center;">
                <div style="flex: 1; min-width: 200px;">
                    <input 
                        type="search" 
                        id="file-search" 
                        placeholder="üîç Search files..." 
                        style="width: 100%; padding: 10px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px; background: var(--bg-secondary);"
                    >
                </div>
                <select 
                    id="file-type-filter" 
                    style="padding: 10px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px; background: var(--bg-secondary); cursor: pointer;"
                >
                    <option value="all">All Types</option>
                    <option value="pdf">PDFs</option>
                    <option value="doc,docx">Documents</option>
                    <option value="xls,xlsx,csv">Spreadsheets</option>
                    <option value="jpg,jpeg,png,gif">Images</option>
                    <option value="mp4,avi,mov">Videos</option>
                    <option value="zip,rar,7z">Archives</option>
                </select>
                <select 
                    id="file-sort" 
                    style="padding: 10px 16px; border: 1px solid var(--border-color); border-radius: var(--radius-md); font-size: 14px; background: var(--bg-secondary); cursor: pointer;"
                >
                    <option value="name-asc">Name (A-Z)</option>
                    <option value="name-desc">Name (Z-A)</option>
                    <option value="date-desc">Newest First</option>
                    <option value="date-asc">Oldest First</option>
                    <option value="size-desc">Largest First</option>
                    <option value="size-asc">Smallest First</option>
                </select>
            </div>
            <div id="files-container" class="files-grid view-grid">
                <!-- Files will be loaded here -->
            </div>
        </main>
    </div>
    
    <script src="js/file-preview.js"></script>
    <script src="js/files-view-toggle.js"></script>
    <script src="js/gallery.js" defer></script>
    <script src="js/pull-to-refresh.js"></script>
    <script>
        // Wait for storage to be ready
        function waitForStorage() {
            return new Promise((resolve) => {
                if (window.storage && window.storage.get) {
                    resolve();
                    return;
                }
                const checkInterval = setInterval(() => {
                    if (window.storage && window.storage.get) {
                        clearInterval(checkInterval);
                        resolve();
                    }
                }, 50);
                // Timeout after 5 seconds
                setTimeout(() => {
                    clearInterval(checkInterval);
                    resolve();
                }, 5000);
            });
        }
        
        async function renderFiles() {
            // Wait for storage to be available
            await waitForStorage();
            const container = document.getElementById('files-container');
            let filesCatalog = [];
            
            // Try to load from storage
            try {
                const filesData = await window.storage.get('site-files');
                if (filesData && filesData.value) {
                    filesCatalog = JSON.parse(filesData.value);
                }
            } catch (error) {
                console.log('No files in storage');
            }
            
            if (filesCatalog.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="grid-column: 1 / -1;">
                        <div class="empty-state-icon">üìÅ</div>
                        <p>No files yet. Add some in the settings!</p>
                    </div>
                `;
                updateFileCount();
                return;
            }
            
            container.innerHTML = '';
            filesCatalog.forEach(file => {
                const card = createFileCard(file);
                container.appendChild(card);
            });
            
            updateFileCount();
        }
        
        function createFileCard(file) {
            const card = document.createElement('div');
            card.className = 'file-card';
            card.dataset.filename = file.name.toLowerCase();
            card.dataset.filetype = file.type.toLowerCase();
            
            const icon = getFileIcon(file.type);
            const isPDF = file.type.toLowerCase() === 'pdf';
            const isPreviewable = isPDF || isImageFile(file.type) || isVideoFile(file.type);
            
            if (isPreviewable) {
                card.style.cursor = 'pointer';
            }
            
            card.innerHTML = `
                <div class="file-icon">${icon}</div>
                <div class="file-name">${file.name}</div>
                ${file.desc ? `<div class="file-description">${file.desc}</div>` : ''}
                <div class="file-meta">
                    <span>${file.type.toUpperCase()}</span>
                    ${file.size ? `<span>${file.size}</span>` : ''}
                    ${file.uploadDate ? `<span>${formatDate(file.uploadDate)}</span>` : ''}
                </div>
                <div class="btn-group" style="display: flex; gap: var(--spacing-xs); margin-top: var(--spacing-sm);">
                    ${isPreviewable ? `
                        <button class="download-btn" onclick="window.filePreview.show(${JSON.stringify(file).replace(/"/g, '&quot;')}); event.stopPropagation();" style="flex: 1; justify-content: center;">
                            <span>üëÅÔ∏è</span>
                            <span>Preview</span>
                        </button>
                    ` : ''}
                    <a href="${file.path}" download class="download-btn" style="flex: 1; justify-content: center; background: var(--bg-secondary); color: var(--text-primary);">
                        <span>‚¨áÔ∏è</span>
                        <span>Download</span>
                    </a>
                </div>
            `;
            
            return card;
        }
        
        function isImageFile(type) {
            return ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'].includes(type.toLowerCase());
        }
        
        function isVideoFile(type) {
            return ['mp4', 'webm', 'mov', 'avi', 'mkv'].includes(type.toLowerCase());
        }
        
        function formatDate(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diff = now - date;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            
            if (days === 0) return 'Today';
            if (days === 1) return 'Yesterday';
            if (days < 7) return `${days} days ago`;
            if (days < 30) return `${Math.floor(days / 7)} weeks ago`;
            
            return date.toLocaleDateString();
        }
        
        function updateFileCount() {
            const countEl = document.getElementById('file-count');
            const container = document.getElementById('files-container');
            const visibleCards = container.querySelectorAll('.file-card:not([style*="display: none"])');
            const totalCards = container.querySelectorAll('.file-card').length;
            
            if (visibleCards.length === totalCards) {
                countEl.textContent = `${totalCards} file${totalCards !== 1 ? 's' : ''}`;
            } else {
                countEl.textContent = `${visibleCards.length} of ${totalCards} files`;
            }
        }
        
        function filterAndSortFiles() {
            const container = document.getElementById('files-container');
            const cards = Array.from(container.querySelectorAll('.file-card'));
            
            const searchTerm = document.getElementById('file-search').value.toLowerCase();
            const typeFilter = document.getElementById('file-type-filter').value;
            const sortBy = document.getElementById('file-sort').value;
            
            // Filter
            cards.forEach(card => {
                const filename = card.dataset.filename;
                const filetype = card.dataset.filetype;
                
                let matchesSearch = filename.includes(searchTerm);
                let matchesType = typeFilter === 'all' || typeFilter.split(',').includes(filetype);
                
                if (matchesSearch && matchesType) {
                    card.style.display = '';
                } else {
                    card.style.display = 'none';
                }
            });
            
            // Sort visible cards
            const visibleCards = cards.filter(card => card.style.display !== 'none');
            
            visibleCards.sort((a, b) => {
                const aName = a.dataset.filename;
                const bName = b.dataset.filename;
                
                switch(sortBy) {
                    case 'name-asc':
                        return aName.localeCompare(bName);
                    case 'name-desc':
                        return bName.localeCompare(aName);
                    case 'date-desc':
                    case 'date-asc':
                        // Implement if upload dates are available
                        return 0;
                    case 'size-desc':
                    case 'size-asc':
                        // Implement if file sizes are comparable
                        return 0;
                    default:
                        return 0;
                }
            });
            
            // Re-append in sorted order
            visibleCards.forEach(card => container.appendChild(card));
            
            updateFileCount();
        }
        
        function getFileIcon(type) {
            const icons = {
                'pdf': 'üìÑ',
                'doc': 'üìù',
                'docx': 'üìù',
                'xls': 'üìä',
                'xlsx': 'üìä',
                'ppt': 'üìä',
                'pptx': 'üìä',
                'zip': 'üì¶',
                'rar': 'üì¶',
                'txt': 'üìÉ',
                'jpg': 'üñºÔ∏è',
                'jpeg': 'üñºÔ∏è',
                'png': 'üñºÔ∏è',
                'gif': 'üñºÔ∏è',
                'mp4': 'üé•',
                'mp3': 'üéµ',
                'default': 'üìÑ'
            };
            
            return icons[type.toLowerCase()] || icons['default'];
        }
        
        // Settings button handler
        document.getElementById('settings-btn').addEventListener('click', (e) => {
            e.preventDefault();
            window.location.href = 'admin.html';
        });
        

        
        // Initialize on DOM ready and after storage is available
        document.addEventListener('DOMContentLoaded', async () => {
            await renderFiles();
            
            // Setup search and filter listeners
            document.getElementById('file-search').addEventListener('input', filterAndSortFiles);
            document.getElementById('file-type-filter').addEventListener('change', filterAndSortFiles);
            document.getElementById('file-sort').addEventListener('change', filterAndSortFiles);
            
            // Setup real-time sync - listen for file changes
            if (window.storageEvents) {
                window.storageEvents.on('site-files', async (value) => {
                    console.log('üìÅ Files updated in storage, reloading...');
                    await renderFiles();
                    filterAndSortFiles();
                });
            }
        });
        
        // Also call immediately if DOM already loaded
        if (document.readyState === 'loading') {
            // Already added listener above
        } else {
            renderFiles();
        }
        
        // Initialize pull-to-refresh
        if (window.pullToRefresh) {
            window.pullToRefresh.init(() => {
                // Reload files on pull-to-refresh
                renderFiles();
            });
        }
    </script>

    <script src="js/mobile-header.js" defer></script>
    <script src="js/ui-polish.js" defer></script>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <a href="index.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üì±</span>
            <span>Feed</span>
        </a>
        <a href="files.html" class="mobile-nav-item active">
            <span class="mobile-nav-icon">üìÅ</span>
            <span>Files</span>
        </a>
        <a href="links.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">üîó</span>
            <span>Links</span>
        </a>
        <a href="admin.html" class="mobile-nav-item">
            <span class="mobile-nav-icon">‚öôÔ∏è</span>
            <span>Settings</span>
        </a>
    </nav>
</body>
</html>
